<div class="tabla-wrap">
  <table class="tabla">
    <colgroup>
      <col class="c-actions" />
      <col class="c-id" />
      <col class="c-name" />
      <col class="c-section" />
      <col class="c-seats" />
      <col class="c-start" />
      <col class="c-end" />
      <col class="c-weeks" />
      <col class="c-comments" />
    </colgroup>

    <thead>
        <tr>
        <th>Acciones</th>
        <th>ID Materia</th>
        <th>Nombre Materia</th>
        <th>Sección</th>
        <th>Cupos solicitados</th>
        <th>Fecha inicio</th>
        <th>Fecha final</th>
        <th>Semanas</th>
        <th>Comentarios</th>
      </tr>
    </thead>

    <tbody>
      <ng-container *ngFor="let row of rows; let i = index">
        <!-- Fila principal -->
        <tr [class.is-deleted]="row._state==='deleted'">
          <td class="acciones">
            <button type="button" class="btn-icon" (click)="remove.emit(i)">-</button>
            <button type="button" class="btn-icon" (click)="add.emit()">+</button>
          </td>

          <!-- ID -->
          <td class="cell-autocomplete">
            <input
              class="input"
              [class.input--invalid]="!row.courseId.trim()"
              [ngModel]="row.courseId"
              (ngModelChange)="patch.emit({index:i, data:{courseId: $event}}); onSearch(i, $event)"
              (focus)="onSearch(i, row.courseId)"
              (blur)="closeList(i)"
              placeholder="ID del curso *" />
            <ul class="suggest suggest--id-only" *ngIf="showList[i]">
              <li *ngFor="let s of suggestions[i]" (click)="selectCourse(i, s)" (keydown.enter)="selectCourse(i, s)">
                <span class="id">{{ s.id }}</span>
              </li>
            </ul>
          </td>

          <!-- Nombre -->
          <td class="cell-autocomplete">
            <input
              class="input"
              [class.input--invalid]="!row.courseName.trim()"
              [ngModel]="row.courseName"
              (ngModelChange)="patch.emit({index:i, data:{courseName: $event}}); onSearch(i, $event)"
              (focus)="onSearch(i, row.courseName)"
              (blur)="closeList(i)"
              placeholder="Buscar por nombre *" />
            <ul class="suggest suggest--name-only" *ngIf="showList[i]">
              <li *ngFor="let s of suggestions[i]" (click)="selectCourse(i, s)" (keydown.enter)="selectCourse(i, s)">
                <span class="name">{{ s.name }}</span>
              </li>
            </ul>
          </td>

          <td>
            <span class="section-readonly">{{ row.section || '-' }}</span>
          </td>

          <td>
            <input
              class="input"
              [class.input--invalid]="!row.seats || row.seats <= 0"
              type="number"
              min="1"
              [ngModel]="row.seats"
              (ngModelChange)="onSeatsInput(i, $event)"
              placeholder="Cupos *" />
          </td>

          <td>
            <div class="date-field-wrapper">
              <input
                class="input"
                [class.input--invalid]="!row.startDate || getStartDateError(i)"
                type="date"
                [ngModel]="row.startDate"
                (ngModelChange)="onStartChange(i, $event)" />
              <div class="error-icon" 
                   *ngIf="getStartDateError(i)"
                   [title]="getStartDateError(i)"
                   [attr.aria-label]="getStartDateError(i)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" 
                        stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </td>

          <td>
            <div class="date-field-wrapper">
              <input
                class="input"
                [class.input--invalid]="!row.endDate || getEndDateError(i)"
                type="date"
                [ngModel]="row.endDate"
                (ngModelChange)="onEndChange(i, $event)" />
              <div class="error-icon" 
                   *ngIf="getEndDateError(i)"
                   [title]="getEndDateError(i)"
                   [attr.aria-label]="getEndDateError(i)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" 
                        stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
          </td>

          <td>
            <span class="weeks-readonly">{{ row.weeks }}</span>
          </td>

          <!-- Comentarios: textarea que crece según contenido (ahora después de semanas) -->
          <td>
            <textarea
              class="input comments-textarea"
              rows="1"
              [ngModel]="row.comments"
              (ngModelChange)="onCommentChange(i, $event)"
              (input)="autoGrow($event.target)"
              placeholder="Comentarios..."
            ></textarea>
          </td>
        </tr>

        <!-- Expander (siempre visible) -->
        <tr class="expander-row">
          <td colspan="9">
            <button class="expander" type="button" (click)="row._open = !row._open">
              <span class="caret" [class.open]="row._open">▸</span>
              Horarios
              <span class="required-indicator" *ngIf="!hasValidSchedules(row)">*</span>
            </button>
          </td>
        </tr>

        <!-- Bloque de horarios (solo si _open) -->
        <tr *ngIf="row._open">
          <td colspan="9">
            <app-schedules-table [(rows)]="row.schedules"></app-schedules-table>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>

<!-- Modal con overlay -->
<div class="modal-overlay" 
     (click)="onClose()" 
     (keydown.escape)="onClose()">
  <!-- Contenedor del popup -->
  <div class="modal-container" 
       (click)="$event.stopPropagation()"
       (keydown)="$event.stopPropagation()"
       aria-labelledby="modal-title"
       aria-describedby="modal-content">
    
    <!-- T√≠tulo del popup -->
    <h2 id="modal-title" class="popup-title">
      {{ showPreview ? 'Vista Previa del Semestre' : 'Duplicaci√≥n Solicitudes Semestres Anteriores' }}
    </h2>
    
    <!-- L√≠nea divisoria -->
    <div class="hr-line"></div>
    
    <!-- Contenido del popup -->
    <div id="modal-content" class="modal-content">
      
      <!-- Vista de selecci√≥n de semestre -->
      @if (!showPreview) {
        <div class="semester-selection">
          <!-- Pregunta -->
          <p class="question-text">¬øCu√°l semestre desea duplicar?</p>
          
          <!-- Desplegable de semestres -->
          <div class="select-container">
            <select 
              class="semester-select" 
              [(ngModel)]="selectedSemester" 
              (change)="onSemesterChange()">
              <option value="" disabled>Seleccione un semestre</option>
              @for (semester of availableSemesters; track semester) {
                <option [value]="semester">
                  {{ semester }}
                </option>
              }
            </select>
          </div>
          
          <!-- Mensaje de error -->
          @if (error) {
            <div class="error-message">
              {{ error }}
            </div>
          }
        </div>
      }
      
      <!-- Vista previa del semestre -->
      @if (showPreview && previewData) {
        <div class="semester-preview">
          <div class="preview-header">
            <h3>Semestre {{ selectedSemester }}</h3>
            <p class="preview-summary" [ngClass]="{'success': previewData.requests.length > 0, 'warning': previewData.requests.length === 0}">
              {{ previewMessage }}
            </p>
          </div>
          
          @if (previewData.requests.length > 0) {
            <div class="preview-requests">
              @for (request of previewData.requests; track request) {
                <div class="request-item">
                  <div class="request-header">
                    <h4 class="course-name">{{ request.courseName || 'Curso sin nombre' }}</h4>
                    <div class="request-details">
                      <span class="capacity">Capacidad: {{ request.capacity || 0 }}</span>
                      <span class="dates">
                        {{ request.startDate | date:'dd/MM/yyyy' }} - {{ request.endDate | date:'dd/MM/yyyy' }}
                      </span>
                    </div>
                  </div>
                  
                  @if (request.schedules && request.schedules.length > 0) {
                    <div class="schedules">
                      @for (schedule of request.schedules; track schedule) {
                        <div class="schedule-item">
                          <span class="day">{{ formatDay(schedule.day) }}</span>
                          <span class="time">{{ schedule.startTime }} - {{ schedule.endTime }}</span>
                          <span class="modality">{{ formatModality(schedule.modalityId) }}</span>
                          <span class="room-type">{{ formatRoomType(schedule.classRoomTypeId) }}</span>
                        </div>
                      }
                    </div>
                  }
                  
                  @if (request.observation) {
                    <div class="observation">
                      <span class="observation-label">Observaci√≥n:</span>
                      <span class="observation-text">{{ request.observation }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          }
          
          @if (previewData.requests.length === 0) {
            <div class="no-requests">
              <p>‚ùå {{ previewMessage }}</p>
            </div>
          }
        </div>
      }
      
      <!-- Indicador de carga -->
      @if (loading) {
        <div class="loading-indicator">
          <p>üîÑ Cargando...</p>
        </div>
      }
      
    </div>
    
    <!-- Botones de acci√≥n -->
    <div class="modal-actions">
      <button 
        type="button" 
        class="btn btn--secondary" 
        (click)="onClose()" 
        [disabled]="loading">
        Cancelar
      </button>
      
      <!-- Botones para vista de selecci√≥n -->
      @if (!showPreview) {
        <div class="action-buttons">
          <button 
            type="button" 
            class="btn btn--outline" 
            [disabled]="!selectedSemester || loading"
            (click)="onShowPreview()">
            Vista Previa
          </button>
          
          <button 
            type="button" 
            class="btn btn--primary" 
            [disabled]="!selectedSemester || loading"
            (click)="onApply()">
            Aplicar Directamente
          </button>
        </div>
      }
      
      <!-- Botones para vista previa -->
      @if (showPreview) {
        <div class="action-buttons">
          <button 
            type="button" 
            class="btn btn--secondary" 
            (click)="onBackToSelection()" 
            [disabled]="loading">
            Volver
          </button>
          
          <button 
            type="button" 
            class="btn btn--primary" 
            [disabled]="loading || (previewMessage && previewMessage.includes('No hay'))"
            (click)="onApply()">
            Aplicar Solicitudes
          </button>
        </div>
      }
    </div>
    
  </div>
</div>
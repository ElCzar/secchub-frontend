<div class="tabla-wrap">
  <table class="tabla">
    <colgroup>
      <col class="c-actions" />
      <col class="c-estado" />
      <col class="c-id" />
      <col class="c-name" />
      <col class="c-section" />
      <col class="c-class-id" />
      <col class="c-seats" />
      <col class="c-start" />
      <col class="c-end" />
      <col class="c-weeks" />
      <col class="c-teacher" />
      <col class="c-status" />
      <col class="c-email" />
      <col class="c-observations" />
    </colgroup>
    <thead>
      <tr>
        <th>Acciones</th>
        <th>Estado</th>
        <th>ID Materia</th>
        <th>Materia</th>
        <th>Secci√≥n Acad√©mica</th>  <!-- Antes llamada solo Secci√≥n -->
        <th>Secci√≥n</th>  <!-- Antes llamada Id clase -->
        <th>Cupos</th>
        <th>Fecha Inicio</th>
        <th>Fecha Final</th>
        <th>Semanas</th>
        <th>Docente</th>
        <th>Estado Docente</th>
        <th>Enviar Correo</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let row of rows; let i = index">
        <!-- Fila principal -->
        <tr class="main-row" [class.is-deleted]="row._state==='deleted'">
          <td class="acciones">
            <button type="button" class="btn-icon" (click)="removeRow.emit(i)" title="Eliminar clase">üóëÔ∏è</button>
            <button type="button" class="btn-icon btn-edit" *ngIf="!row._editing" (click)="editClass(i)">‚úèÔ∏è</button>
            <button type="button" class="btn-icon btn-save" *ngIf="row._editing" (click)="saveClass(i)">üíæ</button>
          </td>

          <!-- Estado -->
          <td class="estado-cell">
            <select 
              class="estado-select"
              [ngModel]="$any(row)._rowStatus || 'Subido'"
              (ngModelChange)="$any(row)._rowStatus = $event"
              [ngClass]="{
                'estado-subido': ($any(row)._rowStatus || 'Subido') === 'Subido',
                'estado-cambiar': ($any(row)._rowStatus || 'Subido') === 'Cambiar',
                'estado-eliminar': ($any(row)._rowStatus || 'Subido') === 'Eliminar',
                'estado-crear': ($any(row)._rowStatus || 'Subido') === 'Crear'
              }">
              <option value="Subido">Subido</option>
              <option value="Cambiar">Cambiar</option>
              <option value="Eliminar">Eliminar</option>
              <option value="Crear">Crear</option>
            </select>
          </td>

          <!-- ID Materia -->
          <td class="cell-autocomplete">
            <ng-container *ngIf="row._editing; else showId">
              <input
                class="input"
                [ngModel]="row.courseId"
                (ngModelChange)="patchRow.emit({index:i, data:{courseId: $event}})"
                (input)="onSearch(i, $any($event.target).value)"
                (focus)="onSearch(i, row.courseId || row.courseName)"
                (blur)="closeList(i)"
                placeholder="Buscar id o nombre" />
              <ul class="suggest" *ngIf="showList[i]">
                <li *ngFor="let s of suggestions[i]" (click)="selectCourse(i, s)" (keypress)="selectCourse(i, s)">
                  <span class="id">{{ s.id }}</span>
                  <span class="name">{{ s.name }}</span>
                </li>
              </ul>
            </ng-container>
            <ng-template #showId>{{ row.courseId }}</ng-template>
          </td>

          <!-- Materia -->
          <td class="cell-autocomplete">
            <ng-container *ngIf="row._editing; else showName">
              <input
                class="input"
                [ngModel]="row.courseName"
                (ngModelChange)="patchRow.emit({index:i, data:{courseName: $event}})"
                (input)="onSearch(i, $any($event.target).value)"
                (focus)="onSearch(i, row.courseName || row.courseId)"
                (blur)="closeList(i)"
                placeholder="Buscar por nombre" />
              <ul class="suggest" *ngIf="showList[i]">
                <li *ngFor="let s of suggestions[i]" (click)="selectCourse(i, s)" (keypress)="selectCourse(i, s)">
                  <span class="id">{{ s.id }}</span>
                  <span class="name">{{ s.name }}</span>
                </li>
              </ul>
            </ng-container>
            <ng-template #showName>{{ row.courseName }}</ng-template>
          </td>

          <!-- Secci√≥n -->
          <td>
            <span class="section-readonly">{{ row.section || 'Seleccione materia' }}</span>
          </td>

          <!-- ID Clase -->
          <td>
            <ng-container *ngIf="row._editing; else showClassId">
              <input class="input" [(ngModel)]="row.classId" />
            </ng-container>
            <ng-template #showClassId>{{ row.classId }}</ng-template>
          </td>

          <!-- Cupos -->
          <td>
            <ng-container *ngIf="row._editing; else showSeats">
              <input class="input" type="number" [(ngModel)]="row.seats" />
            </ng-container>
            <ng-template #showSeats>{{ row.seats }}</ng-template>
          </td>

          <!-- Fecha Inicio -->
          <td>
            <ng-container *ngIf="row._editing; else showStart">
              <input class="input" type="date" 
                     [ngModel]="row.startDate" 
                     (ngModelChange)="onStartDateChange(i, $event)" />
            </ng-container>
            <ng-template #showStart>{{ row.startDate | date: 'shortDate' }}</ng-template>
          </td>

          <!-- Fecha Final -->
          <td>
            <ng-container *ngIf="row._editing; else showEnd">
              <input class="input" type="date" 
                     [ngModel]="row.endDate" 
                     (ngModelChange)="onEndDateChange(i, $event)" />
            </ng-container>
            <ng-template #showEnd>{{ row.endDate | date: 'shortDate' }}</ng-template>
          </td>

          <!-- Semanas (calculadas autom√°ticamente) -->
          <td>
            <ng-container *ngIf="row._editing; else showWeeks">
              <input class="input" type="number" 
                     [ngModel]="getCalculatedWeeks(row)" 
                     readonly 
                     title="Las semanas se calculan autom√°ticamente bas√°ndose en las fechas" />
            </ng-container>
            <ng-template #showWeeks>{{ getCalculatedWeeks(row) }}</ng-template>
          </td>

          <!-- Docente -->
          <td>
            <ng-container *ngIf="row._editing; else showTeacher">
              <div class="teacher-edit-container" *ngIf="getTeacherName(row); else showSelectInEdit">
                <input class="input" #teacherInput [value]="getTeacherName(row)" (input)="updateTeacherName(row, $any($event.target).value)" placeholder="Nombre del docente" />
                <button type="button" class="btn-icon btn-add-teacher" *ngIf="teacherInput.value?.trim()" (click)="selectAdditionalTeacher(i)" title="Agregar docente adicional">+</button>
              </div>
              <ng-template #showSelectInEdit>
                <button type="button" class="btn--primary" (click)="selectTeacher(i)">Seleccionar Docente</button>
              </ng-template>
            </ng-container>
            <ng-template #showTeacher>
              <ng-container *ngIf="hasTeacher(row); else noTeacher">
                <span>{{ row.teacher?.name }}</span>
              </ng-container>
              <ng-template #noTeacher>
                <button type="button" class="btn--primary" (click)="selectTeacher(i)" [disabled]="!row._editing">Seleccionar Docente</button>
              </ng-template>
            </ng-template>
          </td>

          <!-- Estado -->
          <td>
            <span [ngClass]="{'status-pending': row.status === 'PENDIENTE', 'status-confirmed': row.status === 'CONFIRMADO', 'status-rejected': row.status === 'RECHAZADO'}">
              {{ row.status === 'PENDIENTE' ? '‚è≥ Pendiente' : row.status === 'CONFIRMADO' ? '‚úÖ Confirmado' : '‚ùå Rechazado' }}
            </span>
          </td>

          <!-- Enviar Correo -->
          <td>
            <button type="button" class="btn-icon btn-email" (click)="sendEmail(i)" title="Enviar correo">üìß</button>
          </td>

          <!-- Observaciones -->
          <td>
            <button type="button" class="btn--primary" (click)="viewObservations(i)">Ver M√°s</button>
          </td>
        </tr>

        <!-- Expander para horarios -->
        <tr class="expander-row">
          <td colspan="14">
            <div class="expander-inner">
              <button class="expander" type="button" (click)="row._open = !row._open">
                <span class="caret" [class.open]="row._open">‚ñ∏</span> Horarios
              </button>
            </div>
            <div class="separator-line separator-under"></div>
          </td>
        </tr>

        <!-- Bloque de horarios (solo si _open) -->
        <tr *ngIf="row._open">
          <td colspan="14">
            <app-schedules-table-room
              [(rows)]="row.schedules"
              [editable]="row._editing || false"
              (rowsChange)="onSchedulesChange(i, $event)"
              (scheduleDeleted)="onScheduleDeleted(i, $event)">
            </app-schedules-table-room>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>

<app-observaciones-modal
  [show]="showObservationsModal"
  [title]="'Observaciones de la clase'"
  [observaciones]="currentObservations"
  (save)="onSaveObservations($event)"
  (close)="onCloseObservationsModal()">
</app-observaciones-modal>

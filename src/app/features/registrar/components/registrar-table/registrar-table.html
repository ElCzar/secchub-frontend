<div class="register-form-container">

  <!-- Formulario Dinámico -->
  <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="register-form" novalidate>
    
    <!-- Selector de Rol - Siempre visible -->
    <div class="form-section">
      <h2 class="section-title">Selección de Rol</h2>
      
      <div class="form-field">
        <label for="role" class="field-label">Tipo de Usuario *</label>
        <select 
          id="role"
          class="form-select"
          [class.error]="isFieldInvalid('role')"
          formControlName="role">
          <option value="" disabled>Seleccione el tipo de usuario</option>
          <option *ngFor="let role of userRoles" [value]="role.id">
            {{ role.name }}
          </option>
        </select>
        <div *ngIf="isFieldInvalid('role')" class="field-error">
          {{ getFieldErrorMessage('role') }}
        </div>
        <small class="field-note">
          Los campos a completar dependerán del tipo de usuario seleccionado
        </small>
      </div>
    </div>

    <!-- Datos Personales Section - Componente reutilizable -->
    <app-personal-data-form 
      *ngIf="currentRole && hasControl('name')"
      [formGroup]="registerForm"
      [documentTypes]="documentTypes">
    </app-personal-data-form>

    <!-- Datos de Cuenta Section - Solo para roles con login -->
    <div class="form-section" *ngIf="currentRole && hasControl('password')">
      <h2 class="section-title">Contraseña</h2>
      
      <div class="form-row">
        <div class="form-field">
          <label for="password" class="field-label">Contraseña *</label>
          <input 
            id="password"
            type="password" 
            class="form-input"
            [class.error]="isFieldInvalid('password')"
            formControlName="password"
            placeholder="Mínimo 8 caracteres"
            autocomplete="new-password">
          <div *ngIf="isFieldInvalid('password')" class="field-error">
            {{ getFieldErrorMessage('password') }}
          </div>
        </div>

        <div class="form-field">
          <label for="confirmPassword" class="field-label">Confirmar Contraseña *</label>
          <input 
            id="confirmPassword"
            type="password" 
            class="form-input"
            [class.error]="isFieldInvalid('confirmPassword') || hasPasswordMismatch"
            formControlName="confirmPassword"
            placeholder="Repita la contraseña"
            autocomplete="new-password">
          <div *ngIf="isFieldInvalid('confirmPassword')" class="field-error">
            {{ getFieldErrorMessage('confirmPassword') }}
          </div>
          <div *ngIf="hasPasswordMismatch" class="field-error">
            Las contraseñas no coinciden
          </div>
        </div>
      </div>
    </div>

    <!-- Información Específica de Administrador -->
    <app-admin-registrar 
      *ngIf="currentRole === 'admin'" 
      [formGroup]="registerForm">
    </app-admin-registrar>

    <!-- Información Específica de Jefe de Sección -->
    <app-seccion-registrar 
      *ngIf="currentRole === 'section_head'" 
      [formGroup]="registerForm">
    </app-seccion-registrar>

    <!-- Información Específica de Docente -->
    <app-profesor-registrar 
      *ngIf="currentRole === 'teacher'" 
      [formGroup]="registerForm"
      [employmentTypes]="employmentTypes">
    </app-profesor-registrar>

    <!-- Información Específica de Estudiante -->
    <app-estudiante-registrar 
      *ngIf="currentRole === 'student'" 
      [formGroup]="registerForm">
    </app-estudiante-registrar>

    <!-- Información Específica de Programa -->
    <app-programa-registrar 
      *ngIf="currentRole === 'program'" 
      [formGroup]="registerForm">
    </app-programa-registrar>

    <!-- Submit Button -->
    <div class="form-actions">
      <button 
        type="submit" 
        class="btn btn-primary"
        [disabled]="isSubmitDisabled">
        <span *ngIf="isLoading" class="loading-spinner"></span>
        <i *ngIf="!isLoading" class="icon-user-plus" aria-hidden="true"></i>
        {{ isLoading ? 'Registrando...' : 'Registrar Usuario' }}
      </button>

      <button 
        type="button" 
        class="btn btn-secondary"
        (click)="registerForm.reset(); initializeForm()"
        [disabled]="isLoading">
        <i class="icon-refresh" aria-hidden="true"></i>
        Limpiar Formulario
      </button>
    </div>

  </form>
</div>

<!-- Popup de Confirmación -->
<app-pop-confimacion
  [isVisible]="showConfirmationPopup"
  [result]="registrationResult"
  (closeModal)="onCloseConfirmation()"
  (retryRegistration)="onRetryRegistration()">
</app-pop-confimacion>

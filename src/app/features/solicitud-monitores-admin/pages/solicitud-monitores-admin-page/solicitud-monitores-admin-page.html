<app-header></app-header>

<div class="page">
  <!-- Botón toggle que solo aparece cuando el sidebar está oculto -->
  <app-sidebar-toggle-button></app-sidebar-toggle-button>

  <aside class="sidebar">
    <!-- Accesos rápidos permanente -->
    <app-accesos-rapidos-admi></app-accesos-rapidos-admi>
  </aside>

  <main class="content">
    <h1 class="titulo-pagina">Ver y Editar Monitores</h1>
    <div class="hr-line"></div>

    <!-- Filtros de búsqueda (mismo estilo que Planificación) -->
    <div class="filters-container">
      <div class="filter-group">
        <label class="filter-label" for="sm-search">Buscar:</label>
        <input 
          id="sm-search"
          [(ngModel)]="searchQuery" 
          (ngModelChange)="onSearchChange()" 
          placeholder="Buscar por ID, nombre, apellido o correo..." 
          class="search-bar">
      </div>

      <div class="filter-group">
        <label class="filter-label" for="sm-materia">Filtrar por Materia:</label>
        <select id="sm-materia" [(ngModel)]="selectedMateria" (ngModelChange)="onMateriaChange()" class="filter-select">
          <option value="">Todas las materias</option>
          <option *ngFor="let mat of materias" [value]="mat">{{mat}}</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label" for="sm-seccion">Filtrar por Sección:</label>
        <select id="sm-seccion" [(ngModel)]="selectedSeccion" (ngModelChange)="onSeccionChange()" class="filter-select">
          <option value="">Todas las secciones</option>
          <option *ngFor="let sec of secciones" [value]="sec">{{sec}}</option>
        </select>
      </div>
    </div>

    <!-- Botón de guardar cambios -->
    <div class="toolbar">
      <button class="btn btn--primary" (click)="guardarCambios()">Guardar cambios</button>
      <button class="btn btn--secondary" (click)="exportarNomina()">Exportar nómina</button>
    </div>

    <!-- Tabla 1: Monitores Administrativos -->
    <button type="button" class="section-toggle" (click)="showAdminTable = !showAdminTable">
      <span class="caret" [class.open]="showAdminTable">▸</span>
      Monitores Administrativos
    </button>
    <div class="hr-line"></div>
    <ng-container *ngIf="showAdminTable">
      <app-monitores-table
        [monitores]="adminMonitores"
        [adminMode]="true"
        [showMonitorAdministrativo]="false"
        (update)="onMonitoresUpdate($event)">
      </app-monitores-table>
    </ng-container>

    <!-- Tabla 2: Monitores Académicos (todas las columnas actuales excepto Monitor Administrativo) -->
    <button type="button" class="section-toggle" (click)="showAcademicTable = !showAcademicTable">
      <span class="caret" [class.open]="showAcademicTable">▸</span>
      Monitores Académicos
    </button>
    <div class="hr-line"></div>
    <ng-container *ngIf="showAcademicTable">
      <app-monitores-table
        [monitores]="nonAdminMonitores"
        [adminMode]="false"
        [showMonitorAdministrativo]="false"
        (update)="onMonitoresUpdate($event)">
      </app-monitores-table>
    </ng-container>
  </main>
</div>

<!-- Popup de guardar cambios -->
<app-pop-guardar-cambios 
  [visible]="showSaveModal"
  [isSuccess]="saveSuccess"
  [successMessage]="saveSuccess ? 'Los cambios en los monitores se han guardado correctamente' : (totalMonitoresActivos === 0 ? 'No hay monitores para exportar en la nómina.' : 'Nómina exportada correctamente')"
  [errorMessage]="'Error al guardar los cambios. Verifique la conexión e intente nuevamente.'"
  (closed)="onSaveModalClosed()"
  (retry)="onRetrySave()">
</app-pop-guardar-cambios>

<!-- Popup de confirmación de exportar nómina -->
<app-pop-enviar-cambios 
  [visible]="showExportModal"
  [title]="'¿Seguro deseas exportar la nómina de monitores?'"
  [message]="'Se generará un archivo con la información de todos los monitores activos para el proceso de nómina.'"
  [cambiosCount]="totalMonitoresActivos"
  [confirmText]="'Sí, exportar'"
  [cancelText]="'Cancelar'"
  (confirm)="onConfirmExport()"
  (cancelled)="onCancelExport()">
</app-pop-enviar-cambios>

<!-- Popup de tabla de nómina -->
<app-pop-exportar 
  [visible]="showExportTable"
  [monitores]="monitores"
  [title]="'Nómina Monitores'"
  (closed)="onCloseExportTable()"
  (exportar)="onConfirmExportTable()">
</app-pop-exportar>
